<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demir Kƒ±rtasiye Transfer ƒ∞rsaliye Hazƒ±rlama</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fa; text-align: center; padding: 20px; }
    h1 { color: #2c3e50; margin-top: 10px; }
    #logo { max-width: 200px; margin-bottom: 20px; }
    #filterBar { display:flex; justify-content:center; gap:10px; margin-bottom:15px; flex-wrap:wrap;}
    #filterBar button { padding:8px 14px; border-radius:6px; border:none; cursor:pointer; background:#34495e; color:#fff; font-weight:bold; margin-bottom:10px; min-width:120px;}
    #fileInput, #manualBarcode, button { margin: 10px 0; padding: 10px; font-size: 16px; }
    #camera { width: 95%; max-width: 320px; border: 2px solid #3498db; border-radius: 8px; margin: 10px auto; height: 200px; display:none; }
    #productList { margin-top: 20px; text-align: left; }
    .item { display: flex; flex-direction: column; padding: 12px; margin: 6px 0; border: 2px solid #ddd; background-color: #fdfdfd; border-radius: 8px; cursor: pointer; }
    .product-header { display: flex; justify-content: space-between; font-size: 17px; color:#2c3e50; }
    .product-header span:nth-child(2) { font-size: 20px; color: #c0392b; font-weight:bold; }
    .branch-status { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
    .branch-tag { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 14px; }
    .branch-tag.pending { background: #bdc3c7; color: #2c3e50; }
    .branch-tag.approved { background: #27ae60; color: white; }
    .branch-tag.rejected { background: #e74c3c; color: white; }
    #popupOverlay, #branchPopupOverlay, #errorOverlay, #searchPopup, #exportPopup, #importPopup, #overwritePopup {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 999;
    }
    #popupContent, #branchPopupContent, #errorContent, #searchContent, #exportContent, #importContent, #overwriteContent {
      background: #ffffff; padding: 30px; border-radius: 16px; width: 90%; max-width: 550px;
      text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    #searchContent, #exportContent, #importContent, #overwriteContent { max-width:440px;padding:18px 8px 20px 8px; }
    #popupContent { border: 3px solid #27ae60; background: #eafaf1; }
    #errorContent { border: 3px solid #e74c3c; background: #fdecea; }
    #branchPopupContent { border: 3px solid #8e44ad; }
    #popupContent h2, #branchPopupContent h2, #errorContent h2, #searchContent h2,
    #exportContent h2, #importContent h2, #overwriteContent h2 { font-size: 26px; margin-bottom: 10px; font-weight:bold; }
    #popupContent h3, #branchPopupContent h3, #errorContent h3, #searchContent h3,
    #exportContent h3, #importContent h3, #overwriteContent h3 { font-size: 22px; margin-bottom: 15px; font-weight:bold; }
    #popupTable tr.approved-row { background-color: #2ecc71; color: white; }
    #popupTable tr.pending-row { background-color: #e74c3c; color: white; }
    #popupTable td:first-child {
      font-size: 24px;
      font-weight: bold;
      padding: 14px;
      border: 2px solid #3498db;
      border-radius: 8px;
    }
    #popupTable td:last-child {
      font-size: 30px;
      color: #fff;
      font-weight: bold;
      padding: 14px;
    }
    #branchQty {
      font-size: 48px;
      font-weight: bold;
      color: #c0392b;
      margin: 20px 0;
      border: 3px solid #8e44ad;
      padding: 15px;
      border-radius: 10px;
      background: #fceae8;
    }
    .popup-btn { padding: 8px 14px; font-size: 16px; border: none; border-radius: 6px; margin: 6px; cursor: pointer; }
    .approve { background: #27ae60; color: white; }
    .reject { background: #e74c3c; color: white; }
    .item.complete { background-color: #d4edda; border-color: #27ae60; }
    .item.incomplete { background-color: #fff3cd; border-color: #f1c40f; }
    #topBtnBar {
      display: flex; flex-wrap: wrap; gap:10px; justify-content:center; margin-bottom:10px;
    }
    #topBtnBar button { min-width:150px; margin-bottom:5px; }
    @media (max-width: 600px) {
      #topBtnBar { flex-direction: row; gap: 10px 8px;}
      #topBtnBar button { width: 46%; min-width:120px; margin-bottom: 8px;}
      #filterBar { flex-wrap: wrap; }
      #filterBar button { min-width:120px; font-size:14.5px; }
    }
    #searchInput { width:92%; font-size:17px; padding:10px; margin-bottom:8px; border-radius:7px; border:1px solid #ccc; text-align:center;}
    #searchResults { list-style:none; margin:0; padding:0; max-height:220px; overflow-y:auto;}
    #searchResults li { padding:10px 5px; border-bottom:1px solid #e2e2e2; font-size:17px; text-align:left; cursor:pointer;}
    #searchResults li:hover { background:#ecf0f1; }
    /* === ≈ûUBE % BAR (YENƒ∞) === */
    .branch-progress-bar {
      display: inline-block;
      vertical-align: middle;
      margin-left: 6px;
      height: 13px; width: 70px;
      border: 1px solid #bbb; border-radius: 7px; overflow: hidden;
      background: #eee;
    }
    .branch-progress-fill {
      height: 100%;
      display: block;
      background: linear-gradient(90deg, #27ae60 60%, #2ecc71 100%);
      transition: width .25s;
    }
    .branch-progress-label {
      font-size: 12.5px; margin-left:2px;
      font-weight: bold; vertical-align: middle;
    }
    .branch-progress-bar.done {
      background: #c7f7d0;
      border-color: #26b07c;
    }
  </style>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>




<style id="cam-ui-stable">
  #camera{
    position: relative;
    width: 100%;
    max-width: 640px;
    height: 360px;
    margin: 12px auto;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    display: none;
  }
  #camera video, #camera canvas, #camera #interactive{
    position: absolute !important;
    inset: 0 !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
  }
  @media (max-width: 480px){
    #camera{ height: 280px; }
  }
</style>


<style id="cam-mount-style">
  /* Leave #camera as-is (buttons etc. remain visible). Only manage #camMount. */
  #camMount{
    position:absolute; inset:0;
    width:100%; height:100%;
    display:none;      /* hidden until start */
    overflow:hidden; background:#000;
    border-radius:12px;
  }
  /* video/canvas inside mount should fill */
  #camMount video, #camMount canvas, #camMount #interactive{
    position:absolute !important; inset:0 !important;
    width:100% !important; height:100% !important;
    object-fit:cover !important;
  }
</style>

</head>
<body>
  <div>
    <img id="logo" src="logo.png" alt="Demir Kƒ±rtasiye Logo">
    <h1>Demir Kƒ±rtasiye Transfer ƒ∞rsaliye Hazƒ±rlama</h1>
  </div>
  <div id="progressBar" style="margin-bottom:14px; font-size:17px; font-weight:bold; color:#34495e;"></div>
  <div id="topBtnBar">
    <button id="loadFromSheetsBtn">Google Sheets'ten √úr√ºnleri Y√ºkle</button>
    <label><input type="file" id="fileInput" accept=".xlsx,.csv" style="display:none;"><span style="vertical-align:middle;cursor:pointer;" class="btnfile"><b>Dosya Se√ß</b></span></label>
    <button id="startCameraBtn">üì∑ Kamerayƒ± A√ß</button>
    <button id="stopCameraBtn">üì∑ Kamerayƒ± Kapat</button>
    <button id="switchBtn">üì∑ Kamerayƒ± Deƒüi≈ütir</button>
    <button id="openSearchBtn">üîç Barkod/Ad Ara</button>
    <!-- === EKLEMELER (EXPORT/IMPORT) === -->
    <button id="exportBtn" style="background:#ffd700;color:#222;">ƒ∞lerlemeyi Dƒ±≈üa Aktar</button>
    <button id="importBtn" style="background:#1abc9c;color:#fff;">ƒ∞lerleme Y√ºkle</button>
  </div>
  <input type="text" id="manualBarcode" placeholder="Barkodu yazƒ±p Enter‚Äôa bas" onkeypress="if(event.key==='Enter'){checkBarcode(this.value)}"><br>
  <div id="camera" style="display:none;"></div>
  <div id="filterBar">
    <button onclick="filterByBranch('Ataevler')">Ataevler</button>
    <button onclick="filterByBranch('Merkez')">Merkez</button>
    <button onclick="filterByBranch('Fethiye')">Fethiye</button>
    <button onclick="filterByBranch('Topkapƒ±')">Topkapƒ±</button>
    <button onclick="filterByBranch('Depoda Kalan')">Depoda Kalan</button>
    <button onclick="showUnassigned()">Ayrƒ±lmadƒ±</button>
    <button onclick="clearFilter()">T√ºm√ºn√º G√∂ster</button>
  </div>
  <div id="productList"></div>
  <div id="popupOverlay">
    <div id="popupContent">
      <h2 id="popupProductName"></h2>
      <h3 id="popupProductDesc"></h3>
      <table id="popupTable"></table>
      <button id="closePopup">Kapat</button>
    </div>
  </div>
  <div id="errorOverlay">
    <div id="errorContent">
      <h2 style="color:#e74c3c;">√úr√ºn Bu ƒ∞rsaliyede Deƒüil!</h2>
      <button onclick="closeErrorPopup()">Kapat</button>
    </div>
  </div>
  <div id="branchPopupOverlay">
    <div id="branchPopupContent">
      <h2 id="branchPopupBranch"></h2>
      <h3 id="branchPopupProduct"></h3>
      <div id="branchQty"></div>
      <button id="branchApprove" class="popup-btn approve">‚úÖ AYIRDIM</button>
      <button id="branchReject" class="popup-btn reject">‚ùå BEKLƒ∞YOR</button><br>
      <button id="closeBranchPopup">Kapat</button>
    </div>
  </div>
  <!-- Arama Popup -->
  <div id="searchPopup">
    <div id="searchContent">
      <h2>√úr√ºn Ara</h2>
      <input id="searchInput" type="text" placeholder="Barkodun son 6 hanesi veya √ºr√ºn adƒ±..." autocomplete="off">
      <ul id="searchResults"></ul>
      <button onclick="closeSearchPopup()">Kapat</button>
    </div>
  </div>
  <!-- === EKLEMELER: EXPORT/IMPORT MODAL === -->
  <div id="exportPopup">
    <div id="exportContent">
      <h2>ƒ∞lerlemeyi Dƒ±≈üa Aktar</h2>
      <p>A≈üaƒüƒ±daki veriyi <b>json</b> dosyasƒ± olarak kaydedebilirsiniz.</p>
      <textarea id="exportData" style="width:99%;height:110px;"></textarea>
      <br>
      <button onclick="downloadExport()">ƒ∞ndir</button>
      <button onclick="closeExportPopup()">Kapat</button>
    </div>
  </div>
  <div id="importPopup">
    <div id="importContent">
      <h2>ƒ∞lerleme Y√ºkle</h2>
      <input type="file" id="importFileInput" accept=".json" style="margin-bottom:12px;"><br>
      <textarea id="importData" style="width:99%;height:110px;" placeholder="Yapƒ±≈ütƒ±r veya dosya se√ß"></textarea>
      <br>
      <button onclick="loadImport()">Y√ºkle</button>
      <button onclick="closeImportPopup()">Kapat</button>
    </div>
  </div>
  <!-- === YENƒ∞: OVERWRITE/RESET POPUP === -->
  <div id="overwritePopup">
    <div id="overwriteContent">
      <h2>Dikkat!</h2>
      <p>Mevcut i≈üaretlemeler ve ilerleme sƒ±fƒ±rlanacak.<br>Devam etmek istediƒüine emin misin?</p>
      <button id="overwriteYesBtn" style="background:#e74c3c;color:white;">Evet, sƒ±fƒ±rla ve devam et</button>
      <button onclick="closeOverwritePopup()">Vazge√ß</button>
    </div>
  </div>
  <audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
  <audio id="errorSound" src="https://actions.google.com/sounds/v1/alarms/beep_long.ogg"></audio>
  <script>
    // ====================== MEVCUT DEƒûƒ∞≈ûKENLER =========================
    let products = [];
    let currentProduct = null;
    let selectedBranch = null;
    let currentFilter = null;
    let unassignedFilter = false;
    let barcodeInput = document.getElementById('manualBarcode');
    let autoRestartCamera = false;
    const popupOverlay = document.getElementById('popupOverlay');
    const popupProductName = document.getElementById('popupProductName');
    const popupProductDesc = document.getElementById('popupProductDesc');
    const popupTable = document.getElementById('popupTable');
    const errorOverlay = document.getElementById('errorOverlay');
    const successSound = document.getElementById('successSound');
    const errorSound = document.getElementById('errorSound');
    document.querySelector('.btnfile').onclick = function(){ document.getElementById('fileInput').click(); };
    // ====================== EXPORT/IMPORT YENƒ∞ =========================
    // -- localStorage Key
    const STORAGE_KEY = "demirkirtasiye_transfer_v1";
    // -- Export
    document.getElementById('exportBtn').onclick = () => {
      const toExport = {
        products, progressBar: document.getElementById('progressBar').innerHTML
      };
      document.getElementById('exportData').value = JSON.stringify(toExport, null, 2);
      document.getElementById('exportPopup').style.display = 'flex';
    };
    function closeExportPopup() { document.getElementById('exportPopup').style.display = 'none'; }
    function downloadExport() {
      const text = document.getElementById('exportData').value;
      const blob = new Blob([text], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = "irsaliye-ilerleme.json";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    // -- Import
    document.getElementById('importBtn').onclick = () => {
      document.getElementById('importData').value = "";
      document.getElementById('importFileInput').value = "";
      document.getElementById('importPopup').style.display = 'flex';
    };
    function closeImportPopup() { document.getElementById('importPopup').style.display = 'none'; }
    function loadImport() {
      let json;
      try {
        json = document.getElementById('importData').value;
        if (!json) return alert("Bo≈ü veri!");
        const parsed = JSON.parse(json);
        if (!parsed.products) return alert("Hatalƒ± veri.");
        products = parsed.products;
        renderProducts();
        closeImportPopup();
        saveProgress();
      } catch(e) { alert("Ge√ßersiz veya hatalƒ± json!"); }
    }
    document.getElementById('importFileInput').onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        document.getElementById('importData').value = ev.target.result;
      };
      reader.readAsText(file, "UTF-8");
    }
    // -- Kayƒ±t
    function saveProgress() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify({products})); } catch(e){}
    }
    function loadProgress() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (!data) return;
        const obj = JSON.parse(data);
        if(obj.products) {
          products = obj.products;
          renderProducts();
        }
      } catch(e){}
    }
    // ====================== MEVCUT KODUN DEVAMI =========================
    function checkBarcode(code) {
      const found = products.find(p => p.Barkodu == code);
      if (found) {
        openPopup(found);
        successSound.volume = 1.0;
        successSound.play();
      } else {
        errorOverlay.style.display = 'flex';
        errorSound.volume = 1.0;
        errorSound.play();
      }
      barcodeInput.value = '';
      if (!cameraRunning) barcodeInput.focus();
    }
    function closeErrorPopup(){
      errorOverlay.style.display = 'none';
      safeFocusBarcodeInput();
      if (autoRestartCamera) startCameraAuto();
    }
    // ====================== SIFIRLAMA ONAY POPUP YENƒ∞ =========================
    function openOverwritePopup(action) {
      document.getElementById('overwritePopup').style.display = "flex";
      document.getElementById('overwriteYesBtn').onclick = function() {
        document.getElementById('overwritePopup').style.display = "none";
        action();
      }
    }
    function closeOverwritePopup() {
      document.getElementById('overwritePopup').style.display = "none";
    }
    // ================ Dosya y√ºklerken ilerleme varsa onayla (YENƒ∞) ===========
    let pendingFileLoad = null;
    document.getElementById('fileInput').addEventListener('change', function(event) {
      if (products.length > 0) {
        pendingFileLoad = () => handleFile(event);
        openOverwritePopup(() => { handleFile(event); products=[]; });
      } else {
        handleFile(event);
      }
    });
    function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        let raw = XLSX.utils.sheet_to_json(sheet, {defval: ""});
        const grouped = {};
        raw.forEach(row => {
          const barkod = row.Barkodu || row.BARKODU || row.Barkod;
          if (!barkod) return;
          if (!grouped[barkod]) {
            grouped[barkod] = {
              Barkodu: barkod,
              Adi: row.Adƒ± || row["Stok Adƒ±"] || row.ADI || "",
              Adet: 0,
              Ataevler: 0,
              Merkez: 0,
              Fethiye: 0,
              Topkapƒ±: 0,
              "Depoda Kalan": 0,
              scannedStatus: {}
            };
          }
          grouped[barkod].Adet += Number(row.ADET || row.Adet || 0);
          grouped[barkod].Ataevler += Number(row.Ataevler || row.ATAEVLER || 0);
          grouped[barkod].Merkez += Number(row.Merkez || row.MERKEZ || 0);
          grouped[barkod].Fethiye += Number(row.Fethiye || row.FETHƒ∞YE || row.FETHIYE || 0);
          grouped[barkod].Topkapƒ± += Number(row.Topkapƒ± || row.TOPKAPI || 0);
          grouped[barkod]["Depoda Kalan"] += Number(row["Depoda Kalan"] || 0);
        });
        products = Object.values(grouped);
        renderProducts();
        saveProgress();
      };
      reader.readAsArrayBuffer(file);
    }
    // ============ Google Sheets Y√ºkleme √ñncesi Uyarƒ± (EK) ===========
    document.getElementById('loadFromSheetsBtn').onclick = function() {
      if (products.length > 0) {
        openOverwritePopup(() => { loadFromSheets(); products=[]; });
      } else {
        loadFromSheets();
      }
    };
    function loadFromSheets() {
      fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRK7MAw7CognKnLh-ez67TDVZBvdgxSNJ5B4P-e2KbHgF2uqnKC4V3atPq485Bqmg/pub?output=csv")
        .then(res => res.text())
        .then(csvText => {
          let parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
          let rows = parsed.data;
          const grouped = {};
          rows.forEach(row => {
            function getCI(obj, field) {
              const key = Object.keys(obj).find(k => k.toLowerCase() === field.toLowerCase());
              return key ? obj[key] : "";
            }
            const barkod = getCI(row, 'Barkodu') || getCI(row, 'BARKODU') || getCI(row, 'Barkod');
            if (!barkod) return;
            if (!grouped[barkod]) {
              grouped[barkod] = {
                Barkodu: barkod,
                Adi: getCI(row, 'Adƒ±') || getCI(row, 'Stok Adƒ±') || getCI(row, 'ADI') || getCI(row, 'Stok adƒ±') || "",
                Adet: 0,
                Ataevler: 0,
                Merkez: 0,
                Fethiye: 0,
                Topkapƒ±: 0,
                "Depoda Kalan": 0,
                scannedStatus: {}
              };
            }
            grouped[barkod].Adet += Number(getCI(row, 'ADET') || getCI(row, 'Adet') || 0);
            grouped[barkod].Ataevler += Number(getCI(row, 'Ataevler') || getCI(row, 'ATAEVLER') || 0);
            grouped[barkod].Merkez += Number(getCI(row, 'Merkez') || getCI(row, 'MERKEZ') || 0);
            grouped[barkod].Fethiye += Number(getCI(row, 'Fethiye') || getCI(row, 'FETHƒ∞YE') || getCI(row, 'FETHIYE') || 0);
            grouped[barkod].Topkapƒ± += Number(getCI(row, 'Topkapƒ±') || getCI(row, 'TOPKAPI') || 0);
            grouped[barkod]["Depoda Kalan"] += Number(getCI(row, "Depoda Kalan") || 0);
          });
          products = Object.values(grouped);
          renderProducts();
          saveProgress();
        })
        .catch(e => alert("Sheets okuma hatasƒ±: " + e));
    }
    // ====================== UX ƒ∞Yƒ∞LE≈ûTƒ∞RME KAMERA SCROLL ======================
    function scrollToCamera() {
      if (!isMobile()) return;
      setTimeout(() => {
        const cam = document.getElementById("camera");
        if (cam && cam.style.display !== "none") cam.scrollIntoView({behavior: "smooth", block:"center"});
      }, 400);
    }
    // ====================== PROGRESS BAR % (EK) =======================
    function renderProducts() {
      const container = document.getElementById('productList');
      container.innerHTML = '';
      const branches = ["Ataevler", "Merkez", "Fethiye", "Topkapƒ±", "Depoda Kalan"];
      let barHtml = '';
      branches.forEach(branch => {
        const filtered = products.filter(p => p[branch] && p[branch] > 0);
        const total = filtered.length;
        const approved = filtered.filter(p => p.scannedStatus[branch] === 'approved').length;
        const percent = total ? Math.round((approved/total)*100) : 0;
        const done = approved === total && total > 0;
        barHtml += `<span style="margin-right:16px;">
          <b>${branch}:</b>
          <span class="branch-progress-bar${done?' done':''}">
            <span class="branch-progress-fill" style="width:${percent}%;background:${done?'#26d07c':'#27ae60'}"></span>
          </span>
          <span class="branch-progress-label">${approved}/${total} (%${percent})${done?" ‚úîÔ∏è":""}</span>
        </span>`;
      });
      document.getElementById('progressBar').innerHTML = barHtml;
      products.forEach(p => {
        if (currentFilter && (!p[currentFilter] || p[currentFilter] === 0)) return;
        if (unassignedFilter) {
          const hasPending = Object.keys(p.scannedStatus).length === 0 || Object.values(p.scannedStatus).includes('pending');
          if (!hasPending) return;
        }
        const div = document.createElement('div');
        div.className = 'item';
        div.onclick = () => openPopup(p);
        const headerDiv = document.createElement('div');
        headerDiv.className = 'product-header';
        headerDiv.innerHTML = `<span>${p.Barkodu} - ${p.Adi}</span><span>${p.Adet} ADET</span>`;
        div.appendChild(headerDiv);
        const branchDiv = document.createElement('div');
        branchDiv.className = 'branch-status';
        branches.forEach(branch => {
          if (p[branch] && p[branch] > 0) {
            const status = p.scannedStatus[branch] || 'pending';
            const span = document.createElement('span');
            span.className = `branch-tag ${status}`;
            span.textContent = `${branch}: ${p[branch]}`;
            branchDiv.appendChild(span);
          }
        });
        div.appendChild(branchDiv);
        let allApproved = branches.every(branch => (!p[branch] || p.scannedStatus[branch] === 'approved'));
        let anyRejected = branches.some(branch => p.scannedStatus[branch] === 'rejected');
        if (allApproved) div.classList.add('complete');
        else if (anyRejected) div.classList.add('incomplete');
        container.appendChild(div);
      });
      saveProgress();
    }
    // ====================== MEVCUT KODUN DEVAMI =========================
    function filterByBranch(branch) {
      currentFilter = branch;
      unassignedFilter = false;
      renderProducts();
    }
    function clearFilter() {
      currentFilter = null;
      unassignedFilter = false;
      renderProducts();
    }
    function showUnassigned() {
      unassignedFilter = true;
      currentFilter = null;
      renderProducts();
    }
    function openPopup(product) {
      currentProduct = product;
      popupProductName.textContent = `Barkod: ${product.Barkodu}`;
      popupProductDesc.textContent = product.Adi;
      popupTable.innerHTML = '';
      ["Ataevler","Merkez","Fethiye","Topkapƒ±","Depoda Kalan"].forEach(branch => {
        if (product[branch] && product[branch] > 0) {
          const tr = document.createElement('tr');
          const status = product.scannedStatus[branch] || 'pending';
          tr.className = (status === 'approved') ? 'approved-row' : 'pending-row';
          tr.style.cursor = 'pointer';
          tr.onclick = () => openBranchPopup(product, branch);
          const tdLabel = document.createElement('td');
          tdLabel.textContent = branch;
          const tdQty = document.createElement('td');
          tdQty.textContent = (product[branch] || 0) + " ADET";
          tr.appendChild(tdLabel);
          tr.appendChild(tdQty);
          popupTable.appendChild(tr);
        }
      });
      popupOverlay.style.display = 'flex';
    }
    function openBranchPopup(product, branch) {
      selectedBranch = branch;
      currentProduct = product;
      branchPopupBranch.textContent = branch.toUpperCase();
      branchPopupProduct.textContent = `${product.Barkodu} - ${product.Adi}`;
      branchQty.textContent = (product[branch] || 0) + " ADET";
      branchPopupOverlay.style.display = 'flex';
    }
    document.getElementById('branchApprove').onclick = () => {
      if (currentProduct && selectedBranch) {
        currentProduct.scannedStatus[selectedBranch] = 'approved';
        renderProducts();
        branchPopupOverlay.style.display = 'none';
        popupOverlay.style.display = 'none';
        safeFocusBarcodeInput();
        if (autoRestartCamera) setTimeout(startCameraAuto, 500);
      }
    };
    document.getElementById('branchReject').onclick = () => {
      if (currentProduct && selectedBranch) {
        currentProduct.scannedStatus[selectedBranch] = 'rejected';
        renderProducts();
        branchPopupOverlay.style.display = 'none';
        popupOverlay.style.display = 'none';
        safeFocusBarcodeInput();
        if (autoRestartCamera) setTimeout(startCameraAuto, 500);
      }
    };
    document.getElementById('closePopup').onclick = () => {
      popupOverlay.style.display = 'none';
      safeFocusBarcodeInput();
      if (autoRestartCamera) setTimeout(startCameraAuto, 500);
    };
    document.getElementById('closeBranchPopup').onclick = () => {
      branchPopupOverlay.style.display = 'none';
      safeFocusBarcodeInput();
      if (autoRestartCamera) setTimeout(startCameraAuto, 500);
    };
    // KAMERA ALT YAPISI
    let html5QrCode = null;
    let cameraDevices = [];
    let cameraRunning = false;
    let currentCameraIndex = 0;
    async function getCameraDevices() {
      cameraDevices = await Html5Qrcode.getCameras();
      if (!cameraDevices.length) {
        alert("Kamera bulunamadƒ±!");
        return false;
      }
      return true;
    }
    async function startCameraAuto() {
      autoRestartCamera = true;
      if (cameraRunning) return;
      if (!await getCameraDevices()) return;
      if (!html5QrCode) html5QrCode = new Html5Qrcode("camera");
      const camId = cameraDevices[currentCameraIndex].id;
      document.getElementById("camera").style.display = "block";
      barcodeInput.blur();
      barcodeInput.setAttribute('readonly', true);
      scrollToCamera();
      html5QrCode.start(
        camId,
        { fps: 15, qrbox: {width: 220, height: 140} },
        (decodedText) => {
          html5QrCode.stop().then(() => {
            cameraRunning = false;
            document.getElementById("camera").style.display = "none";
            barcodeInput.removeAttribute('readonly');
          });
          checkBarcode(decodedText);
        },
        (errorMessage) => {}
      ).then(() => {
        cameraRunning = true;
      }).catch(err => {
        alert("Kamera ba≈ülatƒ±lamadƒ±: " + err);
        document.getElementById("camera").style.display = "none";
        cameraRunning = false;
        barcodeInput.removeAttribute('readonly');
      });
    }
    document.getElementById('startCameraBtn').onclick = startCameraAuto;
    document.getElementById('stopCameraBtn').onclick = async () => {
      autoRestartCamera = false;
      if (html5QrCode && cameraRunning) {
        await html5QrCode.stop();
        cameraRunning = false;
        document.getElementById("camera").style.display = "none";
        barcodeInput.removeAttribute('readonly');
        safeFocusBarcodeInput();
      }
    };
    document.getElementById('switchBtn').onclick = async () => {
      if (!await getCameraDevices()) return;
      if (cameraDevices.length < 2) {
        alert("Ba≈üka kamera yok.");
        return;
      }
      if (cameraRunning && html5QrCode) {
        await html5QrCode.stop();
        cameraRunning = false;
        document.getElementById("camera").style.display = "none";
      }
      currentCameraIndex = (currentCameraIndex + 1) % cameraDevices.length;
      setTimeout(startCameraAuto, 350);
    };
    function isMobile() {
      return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
    }
    function safeFocusBarcodeInput() {
      if (cameraRunning) return;
      if (!isMobile()) {
        barcodeInput.focus();
      } else {
        barcodeInput.blur();
      }
    }
    window.onload = function() {
      loadProgress();
      safeFocusBarcodeInput();
    }
    // ARAMA POPUP
    const searchPopup = document.getElementById('searchPopup');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    document.getElementById('openSearchBtn').onclick = () => {
      searchPopup.style.display = "flex";
      searchInput.value = "";
      renderSearchResults("");
      setTimeout(() => { searchInput.focus(); }, 250);
    };
    function closeSearchPopup() {
      searchPopup.style.display = "none";
      safeFocusBarcodeInput();
      if (autoRestartCamera) setTimeout(startCameraAuto, 250);
    }
    function renderSearchResults(val) {
      let v = val.trim().toLowerCase();
      searchResults.innerHTML = "";
      let filtered = products.filter(p =>
        (p.Barkodu && (p.Barkodu === v || (v.length === 6 && p.Barkodu.endsWith(v)))) ||
        (p.Adi && p.Adi.toLowerCase().includes(v))
      );
      if (!filtered.length) {
        searchResults.innerHTML = '<li>√úr√ºn bulunamadƒ±</li>';
        return;
      }
      filtered.slice(0, 18).forEach(p => {
        let li = document.createElement("li");
        li.innerHTML = `<b>${p.Barkodu}</b> - ${p.Adi}`;
        li.onclick = () => { searchPopup.style.display="none"; openPopup(p); };
        searchResults.appendChild(li);
      });
    }
    searchInput.oninput = function() { renderSearchResults(this.value); }
    searchInput.onkeypress = function(e) {
      if(e.key==="Enter" && searchResults.firstChild) {
        searchResults.firstChild.click();
      }
    };
  </script>
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>

<script id="quagga-clean-integration">
(function(){
  // --- State ---
  var quaggaRunning = false;
  var videoDevices = [];
  var currentDeviceIndex = 0;
  var lastCode = null, lastHitAt = 0;
  var autoRestartCamera = true;
  var cameraHost = document.getElementById('camera');
  var barcodeInput = document.getElementById('barcodeInput') || document.querySelector('input[type="text"], input[autocomplete="off"]');
  var successSound = document.getElementById('successSound') || (function(){ var a = new Audio(); return a; })();

  function safeFocusBarcodeInput(){
    if (!barcodeInput) return;
    try { barcodeInput.removeAttribute('readonly'); barcodeInput.focus(); barcodeInput.select && barcodeInput.select(); } catch(e){}
  }

  function isValidEAN13(code){
    if(!/^\d{13}$/.test(code)) return false;
    var sum = 0;
    for (var i=0;i<12;i++) sum += parseInt(code[i],10) * (i%2===0 ? 1 : 3);
    var check = (10 - (sum % 10)) % 10;
    return check === parseInt(code[12],10);
  }

  async function loadVideoInputs(){
    var devices = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devices.filter(function(d){ return d.kind === 'videoinput'; });
    return videoDevices.length > 0;
  }

  function quaggaConfig(deviceId){
    return {
      inputStream: {
        type: "LiveStream",
        target: cameraHost,
        constraints: {
          deviceId: deviceId ? { exact: deviceId } : undefined,
          facingMode: "environment",
          width: { ideal: 1280 },
          height:{ ideal: 720 }
        },
        area: { top: "20%", right: "10%", left: "10%", bottom: "20%" }
      },
      locator: { patchSize: "large", halfSample: false }, // keskin profil
      numOfWorkers: Math.max(1, (navigator.hardwareConcurrency||2) - 1),
      frequency: 12,
      decoder: { readers: ["ean_reader","ean_8_reader","code_128_reader"] },
      locate: true
    };
  }

  // ---- Global modal guard (all closed -> resume) ----
  (function(){
    var resumeAfter = false, debounce;
    function isShown(node){
      if(!node || node.nodeType!==1) return false;
      if(node.hidden) return false;
      var cs = getComputedStyle(node);
      return !(cs.display==='none' || cs.visibility==='hidden' || parseFloat(cs.opacity)===0);
    }
    function countOpenModals(){
      var nodes = document.querySelectorAll('.modal,[role="dialog"],.popup,#popupOverlay,#branchPopupOverlay,#errorOverlay,#searchPopup,#exportPopup,#importPopup,#overwritePopup,.swal2-container,.swal2-shown');
      var c=0; nodes.forEach(function(n){ if(isShown(n)) c++; });
      return c;
    }
    function tryResume(){
      clearTimeout(debounce);
      debounce = setTimeout(function(){
        if(!resumeAfter) return;
        if (countOpenModals()===0){
          resumeAfter = false;
          if (autoRestartCamera) startCameraAuto();
        }
      }, 300);
    }
    window.__resumeGuard__ = {
      arm: function(){ resumeAfter = true; this.t = Date.now(); },
      pulse: tryResume
    };
    var mo1 = new MutationObserver(function(){ if(resumeAfter) tryResume(); });
    var mo2 = new MutationObserver(function(){ if(resumeAfter) tryResume(); });
    try {
      mo1.observe(document.body,{subtree:true, attributes:true, attributeFilter:['class','style','hidden']});
      mo2.observe(document.body,{subtree:true, childList:true});
      window.addEventListener('focus', function(){ if(resumeAfter) tryResume(); }, true);
    } catch(e){}
  })();

  // --- Optional: wrap existing checkBarcode to arm guard ---
  if (window.checkBarcode) {
    var __origCheck = window.checkBarcode;
    window.checkBarcode = function(code){
      try { window.__resumeGuard__ && window.__resumeGuard__.arm(); } catch(e){}
      return __origCheck.call(this, code);
    };
  } else {
    window.checkBarcode = function(code){
      try { window.__resumeGuard__ && window.__resumeGuard__.arm(); } catch(e){}
      console.log('checkBarcode:', code);
    };
  }

  // --- Public controls ---
  
window.startCameraAuto = async function(){
  if (window.__quaggaInitLock__) return;
  window.__quaggaInitLock__ = true;
  try{ autoRestartCamera = true; }catch(e){}
  try{
    var _h = __ensureCamMount(); cameraHost = _h.host; var camMount = _h.mount;
    if (!cameraHost) { alert("Kamera konteyneri yok (#camera)."); window.__quaggaInitLock__ = false; return; }
    camMount.style.display = "block"; cameraHost.scrollIntoView({behavior:"smooth", block:"center"});
    if (!camMount.style.height) camMount.style.height = "360px";
    try{ camMount.innerHTML = ""; }catch(e){}
    let tries = 0;
    while ((camMount.offsetWidth < 100 || camMount.offsetHeight < 100) && tries < 12){
      await new Promise(r => requestAnimationFrame(r));
      tries++;
    }
    if (camMount.offsetWidth < 100 || camMount.offsetHeight < 100){
      camMount.style.width = "100%";
      camMount.style.height = "360px";
      await new Promise(r => setTimeout(r, 80));
    }

    if (quaggaRunning) { window.__quaggaInitLock__ = false; return; }
    if (!await loadVideoInputs()) { alert("Kamera bulunamadƒ±!"); window.__quaggaInitLock__ = false; return; }

    var savedId = localStorage.getItem("prefCamId");
    if (savedId) {
      var idx = videoDevices.findIndex(function(d){ return d.deviceId === savedId; });
      if (idx >= 0) currentDeviceIndex = idx;
    }
    var devId = (videoDevices[currentDeviceIndex]||{}).deviceId;

    if (barcodeInput) { barcodeInput.blur(); barcodeInput.setAttribute('readonly', true); }

    Quagga.init(quaggaConfig(devId), function(err) {
      if (err) { alert("Quagga init hatasƒ±: " + err); window.__quaggaInitLock__ = false; return; }
      Quagga.start(); quaggaRunning = true; window.__quaggaInitLock__ = false;

      try {
        var track = Quagga.cameraAccess.getActiveTrack();
        if (track && track.applyConstraints) {
          track.applyConstraints({ advanced: [{ focusMode: "continuous" }] }).catch(function(){});
        }
      } catch(e){}

      try { Quagga.offDetected && Quagga.offDetected(); } catch(e){}
      Quagga.onDetected(function(result){
        var code = result && result.codeResult && result.codeResult.code ? result.codeResult.code : null;
        if(!code) return;
        var now = Date.now();
        if (code === lastCode && (now - lastHitAt) < 900) return;
        lastCode = code; lastHitAt = now;
        if (code.length === 13 && !isValidEAN13(code)) return;

        stopQuagga().then(function(){
          try { successSound.volume = 1.0; successSound.play(); } catch(e){}
          if (navigator.vibrate) navigator.vibrate(35);
          try { window.__resumeGuard__ && window.__resumeGuard__.arm(); } catch(e){}
          try { window.checkBarcode(code); } catch(e){ console.warn('checkBarcode error', e); }
        });
      });
    });
  }catch(e){
    alert("Kamera ba≈ülatma hatasƒ±: " + e);
    window.__quaggaInitLock__ = false;
  }
};


  
window.stopQuagga = function(){
  return new Promise(function(resolve){
    try { if (Quagga && Quagga.offDetected) Quagga.offDetected(); } catch(e){}
    try { if (quaggaRunning) { Quagga.stop(); quaggaRunning = false; } } catch(e){}
    if (document.getElementById("camMount")){ var camMount=document.getElementById("camMount"); camMount.style.display="none"; try{ camMount.innerHTML=""; }catch(e){} }catch(e){}
    }
    if (barcodeInput) barcodeInput.removeAttribute('readonly');
    resolve();
  });
};


  // Wire existing buttons if present (non-invasive)
  (function(){
    var stopBtn = document.getElementById('stopCameraBtn');
    if (stopBtn){
      var old = stopBtn.onclick;
      stopBtn.onclick = async function(ev){
        autoRestartCamera = false;
        await window.stopQuagga();
        safeFocusBarcodeInput();
        if (old) try{ old.call(this, ev) }catch(e){}
      };
    }
    var swBtn = document.getElementById('switchBtn');
    if (swBtn){
      var old2 = swBtn.onclick;
      swBtn.onclick = async function(ev){
        if (!await loadVideoInputs()) { alert("Ba≈üka kamera yok."); return; }
        currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
        try { localStorage.setItem("prefCamId", videoDevices[currentDeviceIndex].deviceId); } catch(e){}
        await window.stopQuagga();
        setTimeout(window.startCameraAuto, 350);
        if (old2) try{ old2.call(this, ev) }catch(e){}
      };
    }
  })();
})();
</script>


<script id="camera-starter-binder">
(function(){
  // Provide a manual hook too
  window.openCameraNow = function(){ try{ startCameraAuto && startCameraAuto(); }catch(e){ alert("Kamera ba≈ülatƒ±lamadƒ±: " + e); } };

  // Candidate IDs for a "start camera" button
  var IDS = ["startCameraBtn","startCamera","btnCamera","openCamera","cameraStart","startCameraAuto","btnOpenCamera","kameraAc","kameraBaslat","kamerayiAc"];
  function bindById(){
    IDS.forEach(function(id){
      var el = document.getElementById(id);
      if(!el) return;
      if(el.__camBinder) return;
      var old = el.onclick;
      el.onclick = function(ev){
        try{ startCameraAuto && startCameraAuto(); }catch(e){ alert("Kamera ba≈ülatƒ±lamadƒ±: " + e); }
        if (old) try{ old.call(this, ev); }catch(e){}
      };
      el.__camBinder = true;
    });
  }

  // Text-based matching (avoid the "Kamerayƒ± Deƒüi≈ütir" switch)
  function matchAsStart(el){
    if(!el) return false;
    var t = (el.innerText || el.textContent || "").toLowerCase();
    if(!t) return false;
    if(t.includes("deƒüi≈ütir")) return false;
    return t.includes("kamera") || t.includes("kamerayƒ± a√ß") || t.includes("kamera a√ß") || t.includes("kamera ba≈ülat");
  }

  function bindByText(){
    var btns = document.querySelectorAll('button, .btn, [role="button"]');
    btns.forEach(function(el){
      if(el.__camBinder) return;
      if(!matchAsStart(el)) return;
      var old = el.onclick;
      el.addEventListener('click', function onStart(ev){
        // Prevent binding to switch button accidentally
        if(!matchAsStart(el)) return;
        try{ startCameraAuto && startCameraAuto(); }catch(e){ alert("Kamera ba≈ülatƒ±lamadƒ±: " + e); }
        // old handler as well
        if (old) try{ old.call(el, ev); }catch(e){}
      }, { passive:true });
      el.__camBinder = true;
    });
  }

  // Initial bind + observe DOM changes (for SPA/late render UIs)
  function bindAll(){ bindById(); bindByText(); }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindAll);
  } else { bindAll(); }

  var mo = new MutationObserver(function(){ bindAll(); });
  try{ mo.observe(document.body, {subtree:true, childList:true}); }catch(e){}
})();
</script>


<script id="cam-mount-helper">
(function(){
  window.__ensureCamMount = function(){
    var host = document.getElementById('camera');
    if(!host){
      host = document.createElement('div'); host.id='camera';
      host.style.position='relative'; host.style.width='100%'; host.style.maxWidth='640px';
      host.style.height = host.style.height || '360px';
      host.style.margin='12px auto'; document.body.appendChild(host);
    } else {
      if (getComputedStyle(host).position === 'static') host.style.position='relative';
      if (!host.style.height) host.style.height='360px';
    }
    var mount = document.getElementById('camMount');
    if(!mount){
      mount = document.createElement('div'); mount.id='camMount';
      host.appendChild(mount);
    }
    return {host, mount};
  };
})();
</script>

</body>
</html>

