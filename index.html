<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Demir Kırtasiye — Kamera & Upload (Android Optimize)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<!-- Camera libs -->
<script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
<script src="https://unpkg.com/@zxing/browser@0.1.4/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<style>
  :root{ --bg:#f7f9fc; --ink:#0f172a; --line:#e5e7eb; --brand:#0a66c2; --danger:#dc2626; --muted:#64748b; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink); background:var(--bg); }
  .container{ max-width:1100px; margin:0 auto; padding:14px; }
  h1{ font-size:18px; margin:8px 0 12px; }
  /* Top action bar */
  #bar{ background:linear-gradient(90deg,var(--brand),#22c1c3); color:#fff; box-shadow:0 6px 14px rgba(2,6,23,.15); }
  #bar .wrap{ display:flex; gap:10px; align-items:center; padding:10px 12px; flex-wrap:wrap; }
  #btnScanMain,#btnUploadMain{
    display:inline-flex; align-items:center; gap:8px; border:0; border-radius:999px; cursor:pointer;
    padding:10px 16px; font-weight:800; background:rgba(255,255,255,.15); color:#fff;
  }
  #btnScanMain:active,#btnUploadMain:active{ transform:translateY(1px); }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  input[type="file"],input[type="search"],input[type="tel"]{ padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; }
  .card{ background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:0 6px 16px rgba(2,6,23,.06); margin-top:12px;}
  .card .hd{ padding:10px 12px; border-bottom:1px solid var(--line); font-weight:800 }
  .card .bd{ padding:12px 12px; }
  button.btn{ border:0; border-radius:10px; padding:10px 12px; background:var(--brand); color:#fff; font-weight:800; cursor:pointer }
  button.btn.light{ background:#e2e8f0; color:#0f172a }
  button.btn.danger{ background:var(--danger) }
  .right{ margin-left:auto }
  /* Scanner modal */
  #scanModal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(2,6,23,.45); backdrop-filter:blur(2px); z-index:9999; padding:16px; }
  #scanModal .box{ background:#fff; border:1px solid var(--line); border-radius:14px; width:min(92vw,640px); box-shadow:0 18px 36px rgba(2,6,23,.2); padding:12px;}
  #viewport{ position:relative; width:100%; aspect-ratio:3/4; background:#000; border-radius:12px; overflow:hidden; }
  #scanVideo{ width:100%; height:100%; object-fit:cover; }
  .bar{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:8px; }
  .mini{ font-size:12px; color:#64748b }
  .barcode{ font-family:ui-monospace,Menlo,Consolas,monospace; font-weight:800 }
</style>
</head>
<body>
<!-- Top bar -->
<div id="bar">
  <div class="wrap">
    <button id="btnScanMain"><i class="fa-solid fa-camera"></i> KAMERA AÇ</button>
    <button id="btnUploadMain"><i class="fa-solid fa-file-arrow-up"></i> DOSYA YÜKLE</button>
    <span class="mini" style="opacity:.9">HTTPS önerilir • Android Chrome/ iOS Safari destekli</span>
  </div>
</div>

<div class="container">
  <h1>Fiyat Gör &amp; Etiket Bas — Android Optimize</h1>

  <div class="card">
    <div class="hd">Veri Girişi</div>
    <div class="bd">
      <div class="row">
        <input id="fileInput" type="file" accept=".csv,.xls,.xlsx"/>
        <button id="btnPrint" class="btn">Yazdır</button>
        <button id="btnCartUpload" class="btn light"><i class="fa-solid fa-file-arrow-up"></i> Dosya Yükle</button>
        <div class="right"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="inpName" type="search" placeholder="Ürün adı ile ara" style="flex:1;min-width:220px;">
        <input id="inpBarcode" type="tel" inputmode="numeric" pattern="[0-9]*" enterkeyhint="search" maxlength="13" placeholder="Barkod (son 6 hane)" style="width:220px;">
        <button id="btnScanSecondary" class="btn"><i class="fa-solid fa-camera"></i> Kamera ile Oku</button>
        <button id="btnClear" class="btn light">Temizle</button>
      </div>
    </div>
  </div>
</div>

<!-- Scanner Modal -->
<div id="scanModal">
  <div class="box">
    <h3 style="margin:6px 0 10px">Mobil Barkod Okuma</h3>
    <div id="viewport">
      <video id="scanVideo" autoplay muted playsinline></video>
      <canvas id="scanCanvas" style="display:none"></canvas>
    </div>
    <div class="bar">
      <div class="mini">Son okunan: <b id="scanOut" class="barcode">—</b></div>
      <div style="display:flex; gap:8px;">
        <button id="btnTorch" class="btn light">Flaş</button>
        <button id="btnSwitch" class="btn light">Kamera Değiştir</button>
        <button id="btnClose" class="btn danger">Kapat</button>
      </div>
    </div>
  </div>
</div>

<script>
/*** Upload buttons → file input ***/
(function(){
  function $$(sel){ return document.querySelector(sel); }
  function openFileInput(){
    var el = $$("#fileInput") || document.querySelector('input[type="file"]:not([disabled])');
    if(!el){ alert("Dosya yükleme alanı bulunamadı."); return; }
    var cs = getComputedStyle(el), restore=null;
    if(cs.display==='none' || cs.visibility==='hidden'){
      restore = { display:el.style.display, visibility:el.style.visibility, position:el.style.position, left:el.style.left, top:el.style.top, width:el.style.width, height:el.style.height, opacity:el.style.opacity, zIndex:el.style.zIndex };
      el.style.display='block'; el.style.visibility='visible'; el.style.position='fixed'; el.style.left='-9999px'; el.style.top='0'; el.style.width='1px'; el.style.height='1px'; el.style.opacity='0.01'; el.style.zIndex='10000';
    }
    try{ el.click(); } finally { if(restore){ Object.assign(el.style, restore); } }
  }
  ["#btnUploadMain","#btnCartUpload"].forEach(sel=>{
    var b=document.querySelector(sel); if(b) b.addEventListener("click", function(e){ e.preventDefault(); openFileInput(); });
  });
  // CSV fallback loader
  const input = document.getElementById('fileInput') || document.querySelector('input[type="file"]');
  if(input){
    input.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      if (window.handleFileImport && typeof window.handleFileImport === 'function'){ window.handleFileImport(f); return; }
      if (window.onFileSelected && typeof window.onFileSelected === 'function'){ window.onFileSelected(f); return; }
      if (/\.csv$/i.test(f.name)){
        const txt = await f.text();
        const rows = txt.split(/\r?\n/).map(r=> r.split(';').length>1 ? r.split(';') : r.split(','));
        const head = (rows.shift()||[]).map(s=> (s||'').trim().toLowerCase());
        const col = (k)=> head.findIndex(h=> h && h.includes(k));
        const idxB = col('barkod');
        const idxN = col('ad')>=0? col('ad') : col('ürün');
        const idxP = head.findIndex(h=> /(mağaza|satiş fiyat|fiyat)/.test(h));
        const idxD = head.findIndex(h=> /(fiyat.*tarih|değişiklik)/.test(h));
        window.PRODUCTS = rows.filter(r=>r && r.length>1).map(r=>({
          barcode: (r[idxB]||'').toString().replace(/\s+/g,''),
          name: (r[idxN]||'').toString(),
          price: parseFloat((r[idxP]||'0').toString().replace(',','.'))||0,
          priceDate: r[idxD]||''
        }));
        console.log('Yüklenen ürün:', window.PRODUCTS.length);
        alert('CSV yüklendi: ' + window.PRODUCTS.length + ' ürün.');
      }else{
        alert('Bu projede CSV bekleniyor. XLS/XLSX için kendi okuyucunuza delege ediliyor.');
      }
    });
  }
})();
</script>

<script>
/*** KAMERA — Android optimize (ZXing hints + ROI + autofocus) ***/
(function(){
  const $ = (s)=>document.querySelector(s);
  const modal = $('#scanModal'), video = $('#scanVideo'), canvas = $('#scanCanvas'), ctx = canvas.getContext('2d');
  const out = $('#scanOut'), btnClose = $('#btnClose'), btnSwitch = $('#btnSwitch'), btnTorch = $('#btnTorch');
  const btnScanMain = $('#btnScanMain'), btnScanSecondary = $('#btnScanSecondary');
  const inpBarcode = document.getElementById('inpBarcode');
  let stream=null, track=null, currentDeviceId=null, devices=[], rafId=null;
  let zxingReader = null;
  const isAndroid = /Android/i.test(navigator.userAgent);
  const hasBD = ('BarcodeDetector' in window);

  function setBarcodeValue(code){
    if(!code) return;
    out.textContent = code;
    if(inpBarcode){
      inpBarcode.value = code;
      inpBarcode.dispatchEvent(new Event('input', {bubbles:true}));
      inpBarcode.dispatchEvent(new Event('change', {bubbles:true}));
    }
  }

  function onCode(txt){
    const code = (txt||'').toString().replace(/\D/g,'');
    if(!code) return;
    setBarcodeValue(code);
    stopScan();
    try{
      if (window.PRODUCTS && Array.isArray(PRODUCTS)){
        let p = PRODUCTS.find(x => (''+(x.barcode||'')).replace(/\D/g,'') === code)
             || PRODUCTS.find(x => (''+(x.barcode||'')).slice(-6) === code.slice(-6));
        if (p && typeof window.openProduct === 'function'){ window.openProduct(p); }
        else if (typeof window.filterByLast6 === 'function'){ window.filterByLast6(code.slice(-6)); }
      }else if (typeof window.filterByLast6 === 'function'){ window.filterByLast6(code.slice(-6)); }
    }catch(e){}
    const btnMdlClose = document.getElementById('btnMdlClose');
    if(btnMdlClose){
      const once = ()=>{ btnMdlClose.removeEventListener('click', once); window.__dgStartScan && window.__dgStartScan(); };
      btnMdlClose.addEventListener('click', once);
    }else{
      setTimeout(()=>{ window.__dgStartScan && window.__dgStartScan(); }, 1000);
    }
    if(navigator.vibrate) navigator.vibrate(60);
  }

  async function listCameras(){
    if(!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return [];
    const devs = await navigator.mediaDevices.enumerateDevices();
    return devs.filter(d=>d.kind==='videoinput');
  }

  async function openCamera(deviceId){
    const constraints = {
      audio:false,
      video:{
        deviceId: deviceId ? { exact: deviceId } : undefined,
        facingMode: deviceId ? undefined : { ideal:'environment' },
        width:{ ideal:1280 }, height:{ ideal:720 },
        frameRate: { ideal: 30, max: 60 }
      }
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream; await video.play();
    track = stream.getVideoTracks()[0];
    currentDeviceId = track.getSettings().deviceId || deviceId || null;

    try{
      const caps = track.getCapabilities ? track.getCapabilities() : {};
      const adv = [];
      if ('focusMode' in caps) adv.push({ focusMode: 'continuous' });
      if ('exposureMode' in caps) adv.push({ exposureMode: 'continuous' });
      if ('zoom' in caps){
        const z = Math.min(caps.zoom.max || 2, 2);
        if (z && z > 1) adv.push({ zoom: z });
      }
      if (adv.length) await track.applyConstraints({ advanced: adv });
    }catch(e){}

    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
  }

  function stopScan(){
    if(rafId) cancelAnimationFrame(rafId), rafId=null;
    if(video._zxingReader){ try{ video._zxingReader.reset(); }catch(e){} }
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; track=null; }
    modal.style.display='none';
    out.textContent='—';
  }

  function getZXingReader(){
    if (zxingReader) return zxingReader;
    try{
      const hints = new Map();
      if (window.ZXing && window.ZXing.DecodeHintType){
        hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
          ZXing.BarcodeFormat.EAN_13,
          ZXing.BarcodeFormat.EAN_8,
          ZXing.BarcodeFormat.CODE_128,
          ZXing.BarcodeFormat.UPC_A
        ]);
      }
      if (window.ZXingBrowser && ZXingBrowser.BrowserMultiFormatReader){
        zxingReader = new ZXingBrowser.BrowserMultiFormatReader(hints);
      } else if (window.ZXing && ZXing.BrowserMultiFormatReader){
        zxingReader = new ZXing.BrowserMultiFormatReader(hints);
      } else {
        zxingReader = null;
      }
    }catch(e){ zxingReader = null; }
    return zxingReader;
  }

  async function startScan(){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      alert('Tarayıcınız kamera erişimini desteklemiyor.');
      return;
    }
    if(location.protocol!=='https:' && location.hostname!=='localhost'){
      console.warn('Kamera için HTTPS önerilir.');
    }
    devices = await listCameras();
    try{ await openCamera(currentDeviceId); }
    catch(e){ try{ await openCamera(null); } catch(e2){ console.error(e2); alert('Kamera açılamadı. İzinleri ve HTTPS bağlantısını kontrol edin.'); return; } }
    modal.style.display='grid';
    out.textContent='—';

    const preferZXing = isAndroid || !hasBD;
    if(preferZXing){
      const reader = getZXingReader();
      if(reader){
        reader.decodeFromVideoElementContinuously(video, (result, err)=>{ if(result && result.text){ onCode(result.text); } });
        video._zxingReader = reader;
        return;
      }
    }

    if(hasBD){
      const detector = new BarcodeDetector({ formats:['ean_13','ean_8','code_128','upc_a','qr_code'] });
      let last = 0;
      const loop = async ()=>{
        try{
          const now = performance.now();
          if(now - last > 120){
            last = now;
            const vw = video.videoWidth, vh = video.videoHeight;
            const sw = Math.floor(vw * 0.7), sh = Math.floor(vh * 0.7);
            const sx = Math.floor((vw - sw)/2), sy = Math.floor((vh - sh)/2);
            const bitmap = await createImageBitmap(video, sx, sy, sw, sh);
            const codes = await detector.detect(bitmap);
            if(codes && codes.length){ onCode(codes[0].rawValue || codes[0].value || ''); }
          }
        }catch(_){}
        rafId = requestAnimationFrame(loop);
      };
      rafId = requestAnimationFrame(loop);
      return;
    }

    if(window.jsQR){
      const loop = ()=>{
        try{
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          const img = ctx.getImageData(0,0,canvas.width,canvas.height);
          const qr = jsQR(img.data,img.width,img.height);
          if(qr && qr.data){ onCode(qr.data); }
        }catch(_){}
        rafId = requestAnimationFrame(loop);
      };
      rafId = requestAnimationFrame(loop);
    }else{
      alert('Uygun barkod kütüphanesi bulunamadı.');
    }
  }

  window.__dgStartScan = startScan;
  window.__dgStopScan  = stopScan;

  [btnScanMain, btnScanSecondary].forEach(b=>{ if(b){ b.addEventListener('click', (e)=>{ e.preventDefault(); startScan(); }); }});
  if(btnClose){ btnClose.addEventListener('click', (e)=>{ e.preventDefault(); stopScan(); }); }
  if(btnSwitch){ btnSwitch.addEventListener('click', async ()=>{ devices = await listCameras(); if(!devices.length) return;
    const idx = devices.findIndex(d=> d.deviceId === currentDeviceId);
    const next = devices[(idx+1)%devices.length];
    stopScan(); currentDeviceId = next.deviceId; startScan();
  }); }
  if(btnTorch){ btnTorch.addEventListener('click', async ()=>{
    if(!track){ alert('Kamera açık değil.'); return; }
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    if(!('torch' in caps)) { alert('Flaş desteklenmiyor.'); return; }
    try{
      const set = track.getSettings(); const on = !set.torch;
      await track.applyConstraints({ advanced:[{ torch: on }] });
    }catch(e){ console.warn('Torch apply failed', e); }
  }); }

  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopScan(); });
  window.addEventListener('beforeunload', stopScan);
})();
</script>

</body>
</html>
